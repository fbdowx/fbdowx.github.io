document.addEventListener('DOMContentLoaded', function () {
  const locales = [
    "en", "pt", "es", "fil", "ar", "bn", "id", "th", "vi"
  ];

  const regionMapping = {
    "en": "GB",
    "pt": "BR",
    "es": "ES",
    "fil": "PH",
    "ar": "SA",
    "bn": "BD",
    "id": "ID",
    "th": "TH",
    "vi": "VN"
  };

  function getFlagSrc(countryCode) {
    return /^[A-Z]{2}$/.test(countryCode)
      ? `https://flagsapi.com/${countryCode.toUpperCase()}/shiny/64.png`
      : "";
  }

  function setCookie(name, value, days) {
    const expires = new Date(Date.now() + days * 864e5).toUTCString();
    document.cookie = name + '=' + encodeURIComponent(value) + '; expires=' + expires + '; path=/';
  }

  function getCookie(name) {
    return document.cookie.split('; ').reduce((r, v) => {
      const parts = v.split('=');
      return parts[0] === name ? decodeURIComponent(parts[1]) : r;
    }, '');
  }

  const dropdownBtn = document.getElementById("dropdown-btn");
  const dropdownContent = document.getElementById("dropdown-content");

  function setSelectedLocale(locale) {
    const intlLocale = new Intl.Locale(locale);
    const langName = new Intl.DisplayNames([locale], { type: "language" }).of(intlLocale.language);
    dropdownContent.innerHTML = "";
    const otherLocales = locales.filter((loc) => loc !== locale);
    otherLocales.forEach((otherLocale) => {
      const otherIntlLocale = new Intl.Locale(otherLocale);
      const otherLangName = new Intl.DisplayNames([otherLocale], { type: "language" }).of(otherIntlLocale.language);
      const region = regionMapping[otherLocale];

      const listEl = document.createElement("li");
      listEl.innerHTML = `${otherLangName}<img alt="flag" src="${getFlagSrc(region)}" />`;
      listEl.value = otherLocale;
      listEl.addEventListener("mousedown", function () {
        setSelectedLocale(otherLocale);
      });
      dropdownContent.appendChild(listEl);
    });
    const region = regionMapping[locale];
    dropdownBtn.innerHTML = `<img alt="flag" src="${getFlagSrc(region)}" />${langName}<span class="arrow-down"></span>`;

    // Save the selected locale in a cookie
    setCookie('selectedLocale', locale, 365);

    // Redirect based on the selected locale
    const currentPath = window.location.pathname;
    const newPath = locale === "en" ? "/" : `/${locale}/`;
    if (currentPath !== newPath) {
      window.location.href = newPath;
    }
  }

  dropdownBtn.addEventListener("click", function () {
    dropdownContent.classList.toggle("show");
  });

  // Check for a previously saved locale in cookies
  const savedLocale = getCookie('selectedLocale');
  if (savedLocale && locales.includes(savedLocale)) {
    setSelectedLocale(savedLocale);
  } else {
    // Default to "en"
    setSelectedLocale(locales[0]);

    const browserLang = new Intl.Locale(navigator.language).language;
    const matchedLocale = locales.find((locale) => new Intl.Locale(locale).language === browserLang);
    if (matchedLocale) {
      setSelectedLocale(matchedLocale);
    }
  }

  window.addEventListener("click", function (event) {
    // Get the dropdown button and the dropdown content elements
    const dropdownBtn = document.getElementById('dropdown-btn');
    const dropdownContent = document.querySelector('.dropdown-content');
    // Check if the clicked element is not the dropdown button or the dropdown content
    if (!dropdownBtn.contains(event.target) && !dropdownContent.contains(event.target)) {
      // If the clicked element is outside both, close the dropdown
      if (dropdownContent.classList.contains('show')) {
        dropdownContent.classList.remove('show');
      }
    }
  });

  const navBtns = document.querySelectorAll('.nav-btn');
  navBtns.forEach(function (btn) {
    btn.addEventListener('click', function () {
      btn.classList.toggle('open');
    });
  });
});
