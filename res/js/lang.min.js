document.addEventListener('DOMContentLoaded', function () {
  const locales = [
    "en", "pt", "es", "fil", "ar", "bn", "id", "th", "vi"
  ];

  const regionMapping = {
    "en": "US",
    "pt": "BR",
    "es": "ES",
    "fil": "PH",
    "ar": "SA",
    "bn": "BD",
    "id": "ID",
    "th": "TH",
    "vi": "VN"
  };

  function getFlagSrc(countryCode) {
    return /^[A-Z]{2}$/.test(countryCode)
      ? `https://flagsapi.com/${countryCode.toUpperCase()}/shiny/64.png`
      : "";
  }

  const dropdownBtn = document.getElementById("dropdown-btn");
  const dropdownContent = document.getElementById("dropdown-content");

  function setSelectedLocale(locale) {
    const intlLocale = new Intl.Locale(locale);
    const langName = new Intl.DisplayNames([locale], { type: "language" }).of(intlLocale.language);
    dropdownContent.innerHTML = "";
    const otherLocales = locales.filter((loc) => loc !== locale);
    otherLocales.forEach((otherLocale) => {
      const otherIntlLocale = new Intl.Locale(otherLocale);
      const otherLangName = new Intl.DisplayNames([otherLocale], { type: "language" }).of(otherIntlLocale.language);
      const region = regionMapping[otherLocale];

      const listEl = document.createElement("li");
      listEl.innerHTML = `${otherLangName}<img src="${getFlagSrc(region)}" />`;
      listEl.value = otherLocale;
      listEl.addEventListener("mousedown", function () {
        setSelectedLocale(otherLocale);
      });
      dropdownContent.appendChild(listEl);
    });
    const region = regionMapping[locale];
    dropdownBtn.innerHTML = `<img src="${getFlagSrc(region)}" />${langName}<span class="arrow-down"></span>`;

    // Redirect based on the selected locale
    const currentPath = window.location.pathname;
    let newPath = "";
    if (currentPath.startsWith('/')) {
      newPath = locale === "en" ? "/" : `/${locale}${currentPath}`;
    } else {
      newPath = locale === "en" ? "/" : `/${locale}/${currentPath}`;
    }

    if (currentPath !== newPath) {
      window.location.href = newPath;
    }
  }

  dropdownBtn.addEventListener("click", function () {
    dropdownContent.classList.toggle("show");
  });

  // Default to "en"
  setSelectedLocale(locales[0]);

  const browserLang = new Intl.Locale(navigator.language).language;
  const matchedLocale = locales.find((locale) => new Intl.Locale(locale).language === browserLang);
  if (matchedLocale) {
    setSelectedLocale(matchedLocale);
  }

  window.addEventListener("click", function (event) {
    // Get the dropdown button and the dropdown content elements
    const dropdownBtn = document.getElementById('dropdown-btn');
    const dropdownContent = document.querySelector('.dropdown-content');
    // Check if the clicked element is not the dropdown button or the dropdown content
    if (!dropdownBtn.contains(event.target) && !dropdownContent.contains(event.target)) {
      // If the clicked element is outside both, close the dropdown
      if (dropdownContent.classList.contains('show')) {
        dropdownContent.classList.remove('show');
      }
    }
  });

  const navBtns = document.querySelectorAll('.nav-btn');
  navBtns.forEach(function (btn) {
    btn.addEventListener('click', function () {
      btn.classList.toggle('open');
    });
  });
});
